// AUTOGENERATED FILE. Do not modify this file manually, it will be overwritten.
// finlang v0.2.6-alpha generated this file for C# `hal.DigOutputFromShiftReg` type.
// Source file: `LedBlinker\hal\shift\DigOutputFromShiftReg.cs` (relative to C# solution).
// MD5 hash of source file: 38304c51d1f8132ff141e7c524f56b20.


#include "hal_DigOutputFromShiftReg.h"
#include <string.h>



void hal_DigOutputFromShiftReg_ctor(hal_DigOutputFromShiftReg * self, hal_TxShiftData * shift_data, uint8_t bit_mask)
{
    memset(self, 0, sizeof(*self));
    self->_shift_data = shift_data;
    self->_bit_mask = bit_mask;

    finlang_SimOnly_run(() => {
        // ensure bit mask only has one bit set
        if ((self->_bit_mask ^ (self->_bit_mask - 1)) != 0)
        {
            throw new System_ArgumentException *($"bit_mask must have only one bit set. It was `{self->_bit_mask}`");
        }
    });
}

bool hal_DigOutputFromShiftReg_get_output_state(hal_DigOutputFromShiftReg * self)
{
    return (hal_TxShiftData_get_tx_data(self->_shift_data) & self->_bit_mask) > 0;
}

/// <summary>
/// NOT THREAD SAFE!!!
/// </summary>
/// <param name="state"></param>
void hal_DigOutputFromShiftReg_set_output_state(hal_DigOutputFromShiftReg * self, bool state)
{
    uint8_t data = hal_TxShiftData_get_tx_data(self->_shift_data);
    if (state)
    {
        data |= self->_bit_mask;
    }
    else
    {
        data &= ~self->_bit_mask;
    }
    hal_TxShiftData_set_tx_data(self->_shift_data, data);
}

void hal_DigOutputFromShiftReg_toggle(hal_DigOutputFromShiftReg * self)
{
    if (hal_DigOutputFromShiftReg_get_output_state(self))
    {
        hal_DigOutputFromShiftReg_set_output_state(self, false);
    }
    else
    {
        hal_DigOutputFromShiftReg_set_output_state(self, true);
    }
}

// virtual table implementation for IDigOut. Note that this is extern'd.
const hal_IDigOut_vtable hal_IDigOut_vtable_imp = {
    .set_output_state = (void (*)(void * self, bool state))hal_DigOutputFromShiftReg_set_output_state,
    .get_output_state = (bool (*)(void * self))hal_DigOutputFromShiftReg_get_output_state,
    .toggle = (void (*)(void * self))hal_DigOutputFromShiftReg_toggle,
};

