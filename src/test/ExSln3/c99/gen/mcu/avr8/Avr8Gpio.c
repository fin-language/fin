// AUTOGENERATED FILE. Do not modify this file manually, it will be overwritten.
// finlang v0.3.0-alpha generated this file for C# `mcu.avr8.Avr8Gpio` type.
// Source file: `LedBlinker/mcu/avr8/Avr8Gpio.cs` (relative to C# solution).
// MD5 hash of source file: 3f27477320d365de87489a2eedb31727.


#include "mcu/avr8/Avr8Gpio.h"
#include <string.h>



void mcu_avr8_Avr8Gpio_ctor(mcu_avr8_Avr8Gpio * self, volatile uint8_t * port, uint8_t pin)
{
    memset(self, 0, sizeof(*self));
    /* fin: math.unsafe_mode() */
    self->_port = port;
    self->_pin_mask = ((uint8_t)1 << pin);
}

void PRIVATE_mcu_avr8_Avr8Gpio_ThrowIfAlreadyInstantiated(char const * port, uint8_t pin)
{
    // this can happen because of the ThreadStatic attribute
    if (mcu_avr8_Avr8Gpio__instantiations == NULL)
        mcu_avr8_Avr8Gpio__instantiations = new HashSet<char const *>();

    char const * key = port + pin;
    if (System_Collections_Generic_HashSet_Contains(mcu_avr8_Avr8Gpio__instantiations, key))
        throw new System_InvalidOperationException *($"GPIO {key} already instantiated.");
    System_Collections_Generic_HashSet_Add(mcu_avr8_Avr8Gpio__instantiations, key);
}

bool mcu_avr8_Avr8Gpio_get_output_state(mcu_avr8_Avr8Gpio * self)
{
    return mcu_avr8_Avr8Gpio_read_input(self);
}

void mcu_avr8_Avr8Gpio_toggle(mcu_avr8_Avr8Gpio * self)
{
    PRIVATE_mcu_avr8_Avr8Gpio_ThrowIfSetToInput(self);

    if (mcu_avr8_Avr8Gpio_read_input(self))
    {
        mcu_avr8_Avr8Gpio_set_output_state(self, false);
    }
    else
    {
        mcu_avr8_Avr8Gpio_set_output_state(self, true);
    }
}

// virtual table implementation for IGpio. Note that this is extern'd.
const hal_IGpio_vtable hal_IGpio_vtable_imp = {
    .read_input = (bool (*)(void * self))mcu_avr8_Avr8Gpio_read_input,
    .set_output_state = (void (*)(void * self, bool state))mcu_avr8_Avr8Gpio_set_output_state,
    .get_output_state = (bool (*)(void * self))mcu_avr8_Avr8Gpio_get_output_state,
    .toggle = (void (*)(void * self))mcu_avr8_Avr8Gpio_toggle,
    .enable_pullup = (bool (*)(void * self))mcu_avr8_Avr8Gpio_enable_pullup,
    .disable_pullup = (bool (*)(void * self))mcu_avr8_Avr8Gpio_disable_pullup,
    .set_direction = (void (*)(void * self, hal_GpioDirection direction))mcu_avr8_Avr8Gpio_set_direction,
};

